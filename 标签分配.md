单阶段检测算法的标签分配方法总结

目前主流的轻量化目标检测蒜贩，基本都是单阶段结构（Anthor-base或者Anthor-free）。主体结构主要包括Backbone、Neck、Head和Loss。

> Anchor：可以理解为预选框，网络对anchor内的内容进行分类、位置回归，配合loss计算，检测等。
>
> （正向传播、计算损失、反向传播、梯度下降、正向传播、...）
>
> Anchor-base：会以特征图的网格为基准，创建多个不同长宽比的anchor，并且正负样本的判断，涉及到IoU阈值；
>
> Anchor-free：特征图的网格就是一个anchor，不会再去创建其他anchor，正负样本的判断全看物体是否落在该区域。

其中受限于硬件资源，

- Backbone主要选取轻量化的主干网络，如MobileNet系列、ShuffleNet系列等；
- Neck主要基于FPN的变种，意在增强深层和浅层特征的更好融合；
- Head主要是对Backbone提取到的特征进行解码得到预测结果，具体就是将分类和回归分支单独使用少量卷积解码到指定通道数；
- Loss只存在于训练阶段，用于告诉网络预测结果是否接近标签值，并给出对应惩罚（Loss）通过反向传播指导网络向预期（Loss减小）的方向收敛。 

其中Loss的计算就涉及到正负样本的分配，合适的正负样本对最终检测效果的影响很大（详见ATSS论文分析）。 

---

目前的标签分配方法根据标签是否非负即正为硬标签（Hard LA）和软标签（Soft LA）两大类。

**硬标签分配**方法主要利用预设框或预测框与GT框比较的结果区分正负样本，样本非负即正。

根据正负样本阈值是否会动态变化，硬标签分配方法又细分为静态和动态两类。

- 静态标签分配方法主要基于距离、IOU等先验知识设置固定阈值去区分正负样本，如FCOS、两阶段标检测算法、RFLA等；
- 动态标签分配方法则根据不同策略动态设置阈值选择正负样本，如ATSS、PAA、OTA、DSL、SimOTA等。

<u>硬标签分配本质上不区分训练过程中不同质量的预测框，即样本非负即正</u>。 

**软标签分配**方法会基于预测结果与真实框计算软标签和正负权重，在候选正样本（一般为落在GT内点）的基础上根据正负权重潜在分配正负样本和计算损失，且会<u>在训练过程中动态调整软标签和正负权重</u>，如GFL、VFL、TOOD、DW等。 

> 硬标签：非负即正
>
> 软标签：正负不定，看设定权重

---

硬标签和软标签可以同时使用，硬标签可以为软标签提供候选正样本，不然它将直接使用GT框内样本作为候选正样本。但是联合使用可能会导致对小目标检测不够友好。 

对于小目标，本身落在下采样特征图GT框内的正样本就较少，尤其在基于预测的硬标签分配方法阶段，模型初始化训练效果较差很容易导致分配给小目标的正样本不够，之后在计算损失函数时又引入软标签，进一步对这些正样本区分正负权重，导致最终用于监督训练的正样本损失信号较弱，影响最终的训练和检测效果，这部分在DW论文最后也有提及。但是这样联合使用对于大模型（抗噪和收敛能力强）和中大尺寸物体的检测还是有帮助。 

---

**ATSS：Adaptive Training Sample Selection（自适应训练样本选择）**

原理：基于**L2距离和IoU**等先验信息自适应计算正负样本阈值。

> L2距离（欧式距离）：类似于直角三角形求斜边
>
> L1距离（曼哈顿距离）：同维度差值累加

步骤：

1. 对于图像上每个真实框（GT），在不同层级特征图上选取L2距离最近的前k（默认为9）个预设框作为候选正样本；
2. 针对每个真实框（GT），计算所有层级特征图上候选正样本与真实框的交并比（IOU），并求取均值和方差；
3. 以均值和方差之和作为IOU阈值，大于阈值的候选正样本为最终正样本（分配到多个GT框时选择最大的），剩余为负样本；

---

SimOTA



---

RFLA